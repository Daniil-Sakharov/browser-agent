name: CI

# –¢—Ä–∏–≥–≥–µ—Ä—ã –∑–∞–ø—É—Å–∫–∞ workflow
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

# –†–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è GitHub Actions
permissions:
  contents: read
  pull-requests: read

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö jobs
env:
  GO_VERSION: '1.21'
  GOLANGCI_LINT_VERSION: 'v2.1.5'
  GCI_VERSION: 'v0.13.6'
  GOFUMPT_VERSION: 'v0.8.0'

jobs:
  # ===========================================================================
  # –õ–∏–Ω—Ç–∏–Ω–≥ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  # ===========================================================================
  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout –∫–æ–¥–∞
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # –ù—É–∂–Ω–æ –¥–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –ª–∏–Ω—Ç–µ—Ä–æ–≤
      
      # 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Go
      - name: üîß Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      # 3. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: üì¶ Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      
      # 4. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: üì• Download dependencies
        run: go mod download
      
      # 5. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      - name: üîß Install formatters
        run: |
          mkdir -p ./bin
          GOBIN=$(pwd)/bin go install mvdan.cc/gofumpt@${{ env.GOFUMPT_VERSION }}
          GOBIN=$(pwd)/bin go install github.com/daixiang0/gci@${{ env.GCI_VERSION }}
      
      # 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —á–µ—Ä–µ–∑ gofumpt
      - name: üßº Check gofumpt formatting
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ gofumpt..."
          
          # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ Go —Ñ–∞–π–ª—ã (–∏—Å–∫–ª—é—á–∞—è vendor, bin, mocks)
          FILES=$(find . -type f -name '*.go' \
            ! -path './vendor/*' \
            ! -path '*/mocks/*' \
            ! -path './bin/*')
          
          if [ -z "$FILES" ]; then
            echo "‚úÖ –ù–µ—Ç Go —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏"
            exit 0
          fi
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤)
          UNFORMATTED=$(./bin/gofumpt -l -extra $FILES)
          
          if [ -n "$UNFORMATTED" ]; then
            echo "‚ùå –°–ª–µ–¥—É—é—â–∏–µ —Ñ–∞–π–ª—ã –Ω–µ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω—ã:"
            echo "$UNFORMATTED"
            echo ""
            echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω–æ: task format"
            exit 1
          fi
          
          echo "‚úÖ –í—Å–µ —Ñ–∞–π–ª—ã –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ"
      
      # 7. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–º–ø–æ—Ä—Ç–æ–≤ —á–µ—Ä–µ–∑ gci
      - name: üéØ Check gci imports sorting
        run: |
          echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –∏–º–ø–æ—Ä—Ç–æ–≤ —á–µ—Ä–µ–∑ gci..."
          
          # –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ Go —Ñ–∞–π–ª—ã
          FILES=$(find . -type f -name '*.go' \
            ! -path './vendor/*' \
            ! -path '*/mocks/*' \
            ! -path './bin/*')
          
          if [ -z "$FILES" ]; then
            echo "‚úÖ –ù–µ—Ç Go —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏"
            exit 0
          fi
          
          # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥—É–ª—è –∏–∑ go.mod
          MODULE_NAME=$(go list -m)
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–º–ø–æ—Ä—Ç—ã (diff mode)
          for file in $FILES; do
            DIFF=$(./bin/gci diff -s standard -s default -s "prefix($MODULE_NAME)" "$file")
            if [ -n "$DIFF" ]; then
              echo "‚ùå –ò–º–ø–æ—Ä—Ç—ã –Ω–µ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ —Ñ–∞–π–ª–µ: $file"
              echo "$DIFF"
              echo ""
              echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω–æ: task format"
              exit 1
            fi
          done
          
          echo "‚úÖ –í—Å–µ –∏–º–ø–æ—Ä—Ç—ã –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ"
      
      # 8. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ golangci-lint
      - name: üîß Install golangci-lint
        run: |
          mkdir -p ./bin
          GOBIN=$(pwd)/bin go install github.com/golangci/golangci-lint/v2/cmd/golangci-lint@${{ env.GOLANGCI_LINT_VERSION }}
      
      # 9. –ó–∞–ø—É—Å–∫ golangci-lint
      - name: üîç Run golangci-lint
        run: |
          echo "–ó–∞–ø—É—Å–∫–∞–µ–º golangci-lint..."
          ./bin/golangci-lint run ./... --config=.golangci.yml --timeout=5m
          echo "‚úÖ –õ–∏–Ω—Ç–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ"
      
      # 10. –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      - name: ‚úÖ All checks passed
        if: success()
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë  ‚úÖ –í—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!     ‚ïë"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
  
  # ===========================================================================
  # –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
  # ===========================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: lint  # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ª–∏–Ω—Ç–∏–Ω–≥–∞
    
    steps:
      # 1. Checkout –∫–æ–¥–∞
      - name: üì• Checkout code
        uses: actions/checkout@v4
      
      # 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Go
      - name: üîß Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      # 3. –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: üì¶ Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/go/pkg/mod
            ~/.cache/go-build
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      
      # 4. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
      - name: üì• Download dependencies
        run: go mod download
      
      # 5. –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
      - name: üî® Build project
        run: |
          echo "–°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
          mkdir -p ./bin
          go build -v -o ./bin/agent ./cmd/agent
          echo "‚úÖ –°–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
      
      # 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∏–Ω–∞—Ä–Ω–∏–∫–∞
      - name: ‚úÖ Verify binary
        run: |
          if [ -f ./bin/agent ]; then
            echo "‚úÖ –ë–∏–Ω–∞—Ä–Ω–∏–∫ —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ"
            ls -lh ./bin/agent
          else
            echo "‚ùå –ë–∏–Ω–∞—Ä–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω"
            exit 1
          fi
  
  # ===========================================================================
  # –ò—Ç–æ–≥–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  # ===========================================================================
  status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [lint, build]
    if: always()
    
    steps:
      - name: üìä Check status
        run: |
          if [ "${{ needs.lint.result }}" != "success" ] || [ "${{ needs.build.result }}" != "success" ]; then
            echo "‚ùå CI failed"
            exit 1
          fi
          
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë  üéâ CI –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ!                       ‚ïë"
          echo "‚ïë  ‚úÖ Lint: ${{ needs.lint.result }}"
          echo "‚ïë  ‚úÖ Build: ${{ needs.build.result }}"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
